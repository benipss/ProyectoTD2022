---
title: "PROYECTO TD 2022"
subtitle: Tratamiento de Datos. Grado en Ciencia de Datos- UV
author: "Benito Pastor Sánchez, Carlos Heras Pardo, Hugo Toledo Escrivá y Manuel Perez Perdomo"
#Pone la fecha de generación del documento
date:  "`r Sys.Date()`"  #Pondría la fecha del día actual
# Para que en lugar de "Contents" ponga "Indice" al incluir la tabla de contenido

params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"

# Por defecto se generará un salida html
# Si si quieres otras salidas o varias de ellas descomenta lo que proceda
output:
# Salida pdf. Si se incluye código en LaTex necesitarás tener instalado un compilador de Latex
  pdf_document:
    toc: yes      # Tabla de contenido (índice)
    toc_depth: 3  # Número de niveles de la tabla de contenido (índice) # 1, ##2,###3
#    number_sections: yes # Numeración de las secciones
# Salida html, 
  html_document:
    echo: yes
    number_sections: yes
    theme: lumen    # Aspecto y estilo,otras opciones: cerulean, journal, flatly, darkly, readable, spacelab, united, cosmo, lumen, paper, sandstone, simplex, and yeti 
    toc: yes
# Salida html_notebook, como html, pero con algunas opciones de visualización
  html_notebook:
    echo: yes
    number_sections: yes
    toc: yes
# Esto nos permite traducir estas etiquetas para que aparezcan en otro idioma en caso de que se usen en el documento para referenciar a figuras, tablas, etc
language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
---

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}


# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

# Opciones generales de los chucks. Se utilizarán salvo cambios en el chunk
opts_chunk$set(echo=F, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

# Opciones generales de dígitos cuando se incluyen tablas
#options(xtable.type = 'html')
knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})
#knit_hooks$set(plot = knitr:::hook_plot_html)
```

# Instalación automática de paquetes

```{r}

# Especificamos las librerías necesarias en esta lista

packages = c("tidyverse","knitr","dplyr","mice")

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#verify they are loaded
search()

```

# Introducción del trabajo

Breve introducción donde se indica el contenido del documento:

" El objetivo de este proyecto es abordar un problema de tratamiento de datos que abarque todas las etapas que estamos estudiando a lo largo del curso. En este proyecto analizaremos los datos recogidos por sensores que monitorizan el nivel de ruido en diferentes localizaciones del barrio de Ruzafa. Los datos están disponibles en la plataforma de datos abiertos del Ayuntamiento de Valencia, dentro de la categoría medio ambiente"

# Importacion de los datos.

```{r}
ruta <- "data/"
f <- list.files(path= "./data", pattern = "csv$") 
fusion <- read_csv(paste(ruta,f[1], sep = ""), 
     col_types = cols(`_id` = col_integer(), 
         LAeq = col_number(), LAeq_d = col_number(), 
         LAeq_den = col_number(), LAeq_e = col_number(), 
         LAeq_n = col_number(), dateObserved = col_date(format = "%Y-%m-%d")))%>% mutate(calle = 1)
     
for (i in 2:length(f)){
fichero2 <- read_csv(paste(ruta,f[i], sep = ""),
       col_types = cols(`_id` = col_integer(), 
           LAeq = col_number(), LAeq_d = col_number(), 
           LAeq_den = col_number(), LAeq_e = col_number(), 
           LAeq_n = col_number(), dateObserved = col_date(format = "%Y-%m-%d"))) %>% mutate(calle = i) 

fusion <- union(fusion, fichero2)
 
}

```

# Acondicionamiento de los datos.

```{r}
#Eliminamos las columnas 3, 4 y 5.
fusion <- fusion %>% select(-(3:5))
#Corregimos la comulna de identificacion "_id".
numero <- nrow(fusion)
fusion <- fusion %>% mutate("id" = c(1:numero)) %>% select(-(1))
```

# Detección de NA.

```{r}
#Calculamos el número de NA que existen en nustro conjunto de observaciones.
num_na <- sum(complete.cases(fusion) == TRUE)
num_na

#Calculamos el porcentaje de NA respecto de todos los datos.
100 - ((num_na/nrow(fusion))*100)

#Repetimos el proceso unicamente teniendo en cuenta las variables numéricas.
df_var_num <- fusion %>% select(2:6)
sum(complete.cases(df_var_num) == TRUE)
```

Ya que el numero de observaciones con valores perdidos es muy bajo y estos pertenecen a variables númericas, hemos decidido sustituirlos por un estadístico "robusto" como es la media.

```{r}
#Imputamos los NA.
df_var_num <- mice(df_var_num,m=5,method="mean")
summary(df_var_num)

#Transformamos la lista que nos devuelve el mice a un data frame de nuevo
df_var_num <- complete(df_var_num)

#Comprobamos que hayamos imputado correctamente todos los datos 
sum(complete.cases(df_var_num) == TRUE) == nrow(df_var_num)

```

# Analisis Univariante

```{r}
# Aplicamos la regla boxplot para eliminar los datos considerados outliers.

reglaboxplot <- function(x,na.rm=T) { 
  q3 = quantile(x,0.75,na.rm = na.rm)
  q1 = quantile(x,0.25,na.rm = na.rm)
  rangoiqr = IQR(x,na.rm = na.rm)
  outliers = (x > q3+1.5*rangoiqr) | (x < q1-1.5*rangoiqr)
  return(outliers)
}
#Escogemos unicamente las variables numericas de data frame.
A <-lapply(df_var_num, reglaboxplot)
nombre_var <- names(df_var_num)


#Contamos los outliers de todo el dataframe.
numero = 0
for (x in 1:length(nombre_var)){
numero1 = sum(A[[nombre_var[x]]])
numero = numero + numero1
}
numero


```
